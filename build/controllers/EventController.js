"use strict";define(["./module"],function(e){e.controller("EventController",["$scope","$filter",function(e,t){e.$watchCollection("lastEvents",function(){e.lastEvents.length?(angular.forEach(e.lastEvents,function(n,r,i){e.addIcon(n),e.addMarker(n),n.date=t("date")(new Date(n.startDate),"mediumDate"),e.menu.activeTab.param!=="geo"&&i[r-1]&&n.marker!==undefined&&i[r-1].marker!==undefined&&e.setPaths(n,i[r-1]),e.addPopup(n)}),e.events=e.events.concat(e.lastEvents)):(e.events=[],e.resetCluster())}),e.addIcon=function(t){t.image[3]["#text"]&&(t.icon=L.icon({iconUrl:t.image[3]["#text"],iconSize:e.menu.activeTab.param=="geo"?[75,75]:[25,25],className:"dot"}))},e.addMarker=function(t){t.venue.location["geo:point"]["geo:lat"]&&t.venue.location["geo:point"]["geo:long"]&&t.icon&&(t.marker=L.marker([t.venue.location["geo:point"]["geo:lat"],t.venue.location["geo:point"]["geo:long"]],{icon:t.icon}),e.cluster.addLayer(t.marker))},e.setPaths=function(t,n){t.path=L.polyline([t.marker.getLatLng(),n.marker.getLatLng()],{color:"rgb(204,188,173)",weight:2,opacity:1}).addTo(e.map)},e.addPaths=function(){angular.forEach(e.events,function(t,n,r){t.path&&e.map.addLayer(t.path)})},e.removePaths=function(){angular.forEach(e.events,function(t,n,r){t.path&&e.map.removeLayer(t.path)})},e.$on("resetPaths",e.removePaths),e.addPopup=function(t){if(t.marker==null)return!1;t.selected=!1,t.popup=L.popup({autoPan:!1,closeButton:!1,offset:L.point(0,e.menu.activeTab.param=="geo"?-30:-5),closeOnClick:!1}).setLatLng(t.marker.getLatLng()).setContent('<div class="event-item"><img src="'+t.image[3]["#text"]+'" class="artist-pic" />'+'<div class="artist-data">'+t.date+"<br/>"+t.artists.headliner+"<br/><br/>"+t.venue.name+"<br/>"+t.venue.location.city+" "+t.venue.location.country+"</div></div>"),t.marker.on("mouseover",function(){e.showPopup(t,0)},t),t.marker.on("mouseout",function(){e.hidePopup(t)},t),t.marker.on("click",function(){e.selectEvent(t)},t)},e.selectEvent=function(t){t.popup!=null&&(t.selected?(e.hidePopup(t),t.selected=!1):(e.showPopup(t,1),t.selected=!0,e.$$phase||e.$apply()))},e.showPopup=function(t,n){t.popup!=null&&t.selected==0&&(e.map.addLayer(t.popup),t.focused=!0,n&&e.map.panTo(t.marker.getLatLng()),e.$$phase||e.$apply())},e.hidePopup=function(t){t.popup!=null&&t.selected==0&&(e.map.removeLayer(t.popup),t.focused=!1,e.$$phase||e.$apply())}}])});